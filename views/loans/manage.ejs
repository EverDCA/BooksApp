<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Préstamos</title>
  <link rel="stylesheet" href="/output.css" />
</head>
<body class="min-h-screen bg-gradient-to-t from-zinc-900 via-gray-900 to-slate-900 text-white flex flex-col">
  <%- include('../books/navbar.ejs', { user: user }) %>
  <div class="flex-1 flex flex-col animate-fade">
    <div class="max-w-7xl w-full mx-auto px-4 pt-8 flex-1 flex flex-col">
      <h1 class="text-3xl font-bold mb-8 text-center">Gestión de Préstamos</h1>
      <% if (messages.success) { %>
        <div class="alert alert-success mb-4"><%- messages.success %></div>
      <% } %>
      <% if (messages.error) { %>
        <div class="alert alert-error mb-4"><%- messages.error %></div>
      <% } %>
      <div class="mb-8">
        <form method="get" class="flex flex-wrap gap-4 items-end justify-between">
          <div class="flex flex-col">
            <label for="search" class="font-semibold mb-1">Buscar por nombre de usuario</label>
            <input type="text" id="search" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>" class="input input-bordered w-64 text-black" placeholder="Nombre de usuario...">
          </div>
          <div class="flex flex-col">
            <label for="state" class="font-semibold mb-1">Estado</label>
            <select id="state" name="state" class="select select-bordered w-40 text-black">
              <option value="" <%= !state ? 'selected' : '' %>>Todos</option>
              <option value="1" <%= state == '1' ? 'selected' : '' %>>Activo</option>
              <option value="0" <%= state == '0' ? 'selected' : '' %>>Devuelto</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Filtrar</button>
        </form>
      </div>
      <div class="overflow-x-auto card bg-base-200 border border-base-300 shadow-lg">
        <table class="table table-zebra w-full min-w-[900px]">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Email</th>
              <th>Libro</th>
              <th>Fecha Préstamo</th>
              <th>Fecha Devolución</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% loans.forEach(loan => { %>
              <tr>
                <td><%= loan.User ? loan.User.name : '-' %></td>
                <td><%= loan.User ? loan.User.email : '-' %></td>
                <td><%= loan.Book ? loan.Book.name : '-' %></td>
                <td><%= loan.loan_date ? loan.loan_date.toLocaleDateString() : '-' %></td>
                <td><%= loan.return_date ? loan.return_date.toLocaleDateString() : '-' %></td>
                <td>
                  <form action="/loans/manage/delete/<%= loan.id_loan %>" method="POST" onsubmit="return confirm('¿Eliminar este historial de préstamo?');">
                    <button type="submit" class="btn btn-error btn-xs">Eliminar</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <!-- Paginación -->
      <% if (totalPages > 1) { %>
        <div class="mt-6 flex justify-center">
          <div class="join">
            <a class="join-item btn <%= currentPage === 1 ? 'btn-disabled' : '' %>" href="?page=<%= currentPage - 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= state ? '&state=' + state : '' %>" <%= currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : '' %>>Anterior</a>
            <span class="join-item btn btn-ghost">Página <%= currentPage %> de <%= totalPages %></span>
            <a class="join-item btn <%= currentPage === totalPages ? 'btn-disabled' : '' %>" href="?page=<%= currentPage + 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= state ? '&state=' + state : '' %>" <%= currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : '' %>>Siguiente</a>
          </div>
        </div>
      <% } %>
    </div>
  </div>
  <%- include('../footer.ejs') %>
</body>
</html>
